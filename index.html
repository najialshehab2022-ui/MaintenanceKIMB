<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>نموذج تقرير صيانة</title>
    <meta name="viewport" content="width=1024" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* 1. إعادة تعيين الأساسيات */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* 2. إعدادات الجسم والخلفية */
        body { direction: rtl; text-align: right; background: linear-gradient(135deg, #1a2980, #26d0ce); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; padding-bottom: 100px; }
        /* 3. نص الحقول وعناصر الإدخال */
        input, textarea { text-align: right; resize: none; }
        textarea { white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; min-height: 40px; padding: 8px 12px; }
        .textarea-replacement { text-align: right; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; min-height: 40px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.375rem; background-color: #fff; font-family: inherit; font-size: inherit; color: inherit; display: block; width: 100%; }
        /* 4. الحاوية الرئيسية */
        .container { width: 100%; max-width: 1000px; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); }
        /* 5. تنسيق بحجم ورقة A4 */
        .a4-container { width: auto; margin: auto; background: #fff; padding: 30px; border: 3px solid #2c3e50; border-radius: 15px; box-shadow: 0 0 0 5px #ffffff, 0 0 0 8px #34495e, 0 10px 30px rgba(0, 0, 0, 0.2); position: relative; overflow: visible; }
        .a4-container::before { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; background: linear-gradient(45deg, #3498db, #2ecc71, #e74c3c, #f39c12); border-radius: 20px; z-index: -1; opacity: 0.1; }
        /* 6. استجابة الشاشة والطباعة */
        @media screen and (max-width: 210mm) { .a4-container { width: 100%; padding: 20px; border-width: 2px; } }
        @media print { .no-print { display: none !important; } .a4-container { box-shadow: none; margin: 0; padding: 20px; border: 2px solid #000; } .a4-container::before { display: none; } input, textarea { border: none !important; box-shadow: none !important; } }
        /* 7. أزرار التحكم الثابتة */
        .action-buttons { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 1000; }
        .action-buttons button { padding: 12px 20px; font-size: 16px; color: #fff; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; }
        #shareBtn { background-color: #007bff; }
        #shareBtn:hover { background-color: #0056b3; transform: scale(1.05); }
        #clearStorageBtn { background-color: #dc3545; }
        #clearStorageBtn:hover { background-color: #c82333; transform: scale(1.05); }
        /* 8. محتوى التوقيعات */
        .signature-content { padding: 30px; }
        .signature-container { display: flex; gap: 30px; margin-top: 20px; }
        @media (max-width: 768px) { .signature-container { flex-direction: column; } }
        .signature-box { flex: 1; background: #f8f9fa; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; border: 1px solid #e9ecef; }
        .signature-box:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .signature-box h2 { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #3498db; font-size: 1.6rem; color: #2c3e50; }
        /* 9. لوحة التوقيع */
        .signature-canvas { width: 100%; height: 180px; border: 2px dashed #bdc3c7; border-radius: 10px; background: white; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #bdc3c7; font-size: 18px; transition: all 0.3s; }
        .signature-canvas:hover { border-color: #3498db; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2); }
        /* 11. أزرار التحكم */
        .signature-controls { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-clear { background: #e74c3c; color: white; } .btn-clear:hover { background: #c0392b; transform: scale(1.05); }
        .btn-save { background: #2ecc71; color: white; } .btn-save:hover { background: #27ae60; transform: scale(1.05); }
        /* 12. نافذة التوقيع الكبيرة (Modal) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); animation: modalAppear 0.4s ease-out; }
        @keyframes modalAppear { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.8rem; color: #2c3e50; font-weight: 700; }
        .close-btn { background: #e74c3c; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; transition: all 0.3s; }
        .close-btn:hover { transform: rotate(90deg); background: #c0392b; }
        #largeCanvas { width: 100%; height: 400px; border: 2px solid #ecf0f1; border-radius: 10px; background: white; cursor: crosshair; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px; }
        /* 13. تحسينات الجداول */
        table, th, td { border: 1px solid #dee2e6; text-align: center; vertical-align: middle; }
        .table-bordered, .table-bordered th, .table-bordered td { border: 1px solid #dee2e6; }
        /* 14. قسم الصور المرفقة */
        .photos-section { margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; border: 2px solid #3498db; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1); }
        .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .photo-item { position: relative; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; border: 3px solid #ffffff; }
        .photo-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25); }
        .photo-item img { width: 100%; height: auto; max-height: 250px; object-fit: contain; display: block; }
        .photo-remove, .photo-crop { position: absolute; top: 10px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; }
        .photo-remove { right: 10px; }
        .photo-crop { left: 10px; background: #007bff; }
        .photo-remove:hover { background: #c0392b; transform: scale(1.1); }
        .photo-crop:hover { background: #0056b3; transform: scale(1.1); }
        .photo-buttons { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .photo-btn { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .photo-btn-camera { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }
        .photo-btn-camera:hover { background: linear-gradient(135deg, #138496, #117a8b); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3); }
        .photo-btn-gallery { background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; }
        .photo-btn-gallery:hover { background: linear-gradient(135deg, #5a32a3, #4c2a85); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(111, 66, 193, 0.3); }
        #cameraInput, #galleryInput { display: none; }
        .no-photos { text-align: center; color: #6c757d; font-style: italic; padding: 40px 20px; background: #ffffff; border-radius: 10px; border: 2px dashed #dee2e6; font-size: 16px; }
        /* استايل نافذة قص الصور */
        #cropperModal .modal-content { max-width: 90vw; }
        #imageToCrop { display: block; max-width: 100%; max-height: 70vh; }
        /* 16. تحسينات إضافية للعناوين */
        .section-title { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; font-weight: 700; }
        /* 17. تحسين مظهر الحقول */
        .form-control:focus { border-color: #3498db; box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25); }
        /* 18. تحسين مظهر الأزرار */
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); border: none; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #27ae60, #229954); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #c0392b, #a93226); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }
        /* 19. مؤشر التحميل (جديد) */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .loader-overlay.show { opacity: 1; visibility: visible; }
        .spinner { width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
    </div>

    <div class="a4-container shadow-sm" id="reportArea">
        <div class="container-fluid">
            <div class="row align-items-center text-center mb-4 g-2">
                <div class="col-md-3">
                    <h6 class="fw-bold m-0">بنك الكريمي للتمويل الأصغر الإسلامي</h6>
                </div>
                <div class="col-md-6">
                    <img src="kimb.png" alt="شعار" class="img-fluid" style="max-height: 80px;" crossorigin="anonymous" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">رقم التقرير:</label>
                    <input type="text" class="form-control" placeholder="أدخل رقم التقرير" />
                </div>
            </div>

            <div class="row mb-3">
                <div class="col text-center">
                    <h4 class="fw-bold section-title">نموذج تقرير صيانة</h4>
                </div>
            </div>

            <div class="row mb-4 g-2">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">تم النزول إلى منطقة:</label>
                    <input type="text" class="form-control" placeholder="الخمسين" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">الفرع:</label>
                    <input type="text" id="branchInput" class="form-control" placeholder="حدة" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">اليوم:</label>
                    <input type="text" id="dayInput" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">التاريخ:</label>
                    <input type="text" id="dateInput" class="form-control" />
                </div>
            </div>

            <div class="row align-items-center mb-4">
                <div class="col-md-3 text-md-end text-center mb-2 mb-md-0">
                    <label class="fw-semibold">نوع الصيانة:</label>
                </div>
                <div class="col-md-3 text-center">
                    <input type="radio" name="maintenanceType" id="preventive" class="form-check-input me-2" />
                    <label for="preventive" class="form-check-label">صيانة استباقية</label>
                </div>
                <div class="col-md-3 text-center">
                    <input type="radio" name="maintenanceType" id="emergency" class="form-check-input me-2" />
                    <label for="emergency" class="form-check-label">صيانة طارئة</label>
                </div>
            </div>

            <div class="row mb-4 text-center g-2">
                <div class="col-md-3"><label class="fw-semibold">توصيف الصيانة:</label></div>
                <div class="col-md-3"><input type="checkbox" id="assets" class="form-check-input me-2" /><label for="assets">أصول وخزنات</label></div>
                <div class="col-md-3"><input type="checkbox" id="option3" class="form-check-input me-2" /><label for="option3">صراف الي</label></div>
                <div class="col-md-3"><input type="checkbox" id="option4" class="form-check-input me-2" /><label for="option4">منظومة كاميرات</label></div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label class="fw-semibold">تم القيام بالفحص والتشخيص عن الآتي:</label>
                    <textarea id="diagnosis" class="form-control mb-3" rows="4" placeholder="اكتب تفاصيل الفحص والتشخيص..."></textarea>
                    <label class="fw-semibold">وكانت نتائج الفحص والأسباب هي:</label>
                    <textarea id="results" class="form-control mb-3" rows="4" placeholder="اكتب نتائج الفحص والأسباب..."></textarea>
                    <label class="fw-semibold">وتم تنفيذ المعالجات الآتية:</label>
                    <textarea id="actions" class="form-control" rows="4" placeholder="اكتب المعالجات المنفذة..."></textarea>
                </div>
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center" id="partsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>الأصناف</th>
                                    <th>العدد</th>
                                    <th>قطع الغيار المستبدلة</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><textarea class="form-control" rows="1"></textarea></td>
                                    <td><textarea class="form-control" rows="1"></textarea></td>
                                    <td><textarea class="form-control" rows="1"></textarea></td>
                                    <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">🗑 حذف</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-success" onclick="addRow()">➕ إضافة صف</button>
                </div>
            </div>

            <div class="photos-section">
                <h5 class="fw-bold mb-3 section-title"><i class="fas fa-camera"></i> الصور المرفقة</h5>
                <div class="photo-buttons">
                    <button class="photo-btn photo-btn-camera" onclick="openCamera()"><i class="fas fa-camera"></i> التقاط صورة</button>
                    <button class="photo-btn photo-btn-gallery" onclick="openGallery()"><i class="fas fa-images"></i> اختيار من الاستوديو</button>
                </div>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple onchange="handlePhotoSelection(event)">
                <input type="file" id="galleryInput" accept="image/*" multiple onchange="handlePhotoSelection(event)">
                <div id="photosGrid" class="photos-grid">
                    <div class="no-photos">لا توجد صور مرفقة بعد</div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="fw-bold">مدير الفرع - استلمت أنا:</label>
                        <input type="text" class="form-control" placeholder="اسم المدير" />
                    </div>
                    <p>جميع أعمال الصيانة التي نفذها المهندس والموضحة أعلاه وتم استلام قطع الغيار التالفة منه ولا يوجد أي قصور بالتنفيذ.</p>
                    <label class="fw-bold">توصيات مدير الفرع:</label>
                    <textarea class="form-control mb-2" rows="3" placeholder="اكتب توصيات مدير الفرع..."></textarea>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="fw-bold">اسم مهندس الصيانة:</label>
                        <input type="text" class="form-control" placeholder="اسم المهندس" />
                    </div>
                    <label class="fw-bold">توصيات مهندس الصيانة:</label>
                    <textarea class="form-control mb-2" rows="3" placeholder="اكتب توصيات مهندس الصيانة..."></textarea>
                </div>
            </div>
            
            <div class="signature-content">
                <div class="signature-container">
                    <div class="signature-box">
                        <h2><i class="fas fa-user-tie"></i> توقيع مدير الفرع</h2>
                        <div id="managerSign" class="signature-canvas">انقر هنا للتوقيع</div>
                        <div class="signature-controls">
                            <button class="btn btn-clear" onclick="clearCanvas('managerSign')"><i class="fas fa-eraser"></i> مسح</button>
                            <button class="btn btn-save" onclick="saveSignature('managerSign')"><i class="fas fa-save"></i> حفظ</button>
                        </div>
                    </div>
                    <div class="signature-box">
                        <h2><i class="fas fa-user-cog"></i> توقيع المهندس</h2>
                        <div id="techSign" class="signature-canvas">انقر هنا للتوقيع</div>
                        <div class="signature-controls">
                            <button class="btn btn-clear" onclick="clearCanvas('techSign')"><i class="fas fa-eraser"></i> مسح</button>
                            <button class="btn btn-save" onclick="saveSignature('techSign')"><i class="fas fa-save"></i> حفظ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signatureModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title"><i class="fas fa-signature"></i> التوقيع - المساحة مكبرة</h2>
                        <div class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></div>
                    </div>
                    <canvas id="largeCanvas" width="760" height="400"></canvas>
                    <div class="modal-footer">
                        <button class="btn btn-clear" onclick="clearLargeCanvas()"><i class="fas fa-eraser"></i> مسح</button>
                        <button class="btn btn-save" onclick="saveLargeSignature()"><i class="fas fa-save"></i> حفظ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="cropperModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-crop-alt"></i> قص وتعديل الصورة</h2>
                <div class="close-btn" onclick="closeCropper()"><i class="fas fa-times"></i></div>
            </div>
            <div>
                <img id="imageToCrop" src="" alt="Image to crop">
            </div>
            <div class="modal-footer">
                <button class="btn btn-clear" onclick="closeCropper()"><i class="fas fa-times"></i> إلغاء</button>
                <button class="btn btn-save" onclick="saveCroppedImage()"><i class="fas fa-check"></i> حفظ التعديل</button>
            </div>
        </div>
    </div>

    <div class="action-buttons no-print">
        <button id="shareBtn">📤 شارك التقرير</button>
        <button id="clearStorageBtn">🗑️ مسح البيانات المحفوظة</button>
    </div>

    <script>
        // ===== المتغيرات العامة =====
        let currentCanvasId = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let attachedPhotos = [];
        let cropper = null;
        let currentPhotoIdToCrop = null;

        // ===== الثوابت والإعدادات =====
        const PHOTO_CONFIG = { maxWidth: 1024, maxHeight: 1024, quality: 0.85, format: 'image/jpeg' };
        const STORAGE_KEY = 'maintenanceReportData';
        const EXPIRATION_MINUTES = 5;

        // ===== وظائف رئيسية عند تحميل الصفحة =====
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            flatpickr("#dateInput", { dateFormat: "Y-m-d", defaultDate: today, onChange: (selectedDates) => updateDay(selectedDates[0]) });
            document.getElementById('dateInput').value = today.toISOString().split('T')[0];
            updateDay(today);

            document.getElementById('shareBtn').addEventListener('click', shareReport);
            document.getElementById('clearStorageBtn').addEventListener('click', clearLocalStorage); 
            document.querySelectorAll('textarea').forEach(el => {
                el.addEventListener('input', () => autoExpand(el));
            });

            initLargeCanvas();
            document.getElementById('managerSign').addEventListener('click', () => openModal('managerSign'));
            document.getElementById('techSign').addEventListener('click', () => openModal('techSign'));
            
            loadFromLocalStorage();
        });

        // ===== دوال مساعدة =====
        function updateDay(date) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            document.getElementById('dayInput').value = days[date.getDay()];
        }

        function autoExpand(el) {
            el.style.height = 'auto';
            el.style.height = `${el.scrollHeight}px`;
        }

        // ===== دوال الجداول =====
        function addRow() {
            const tbody = document.querySelector('#partsTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><textarea class="form-control" rows="1"></textarea></td>
                <td><textarea class="form-control" rows="1"></textarea></td>
                <td><textarea class="form-control" rows="1"></textarea></td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">🗑 حذف</button></td>
            `;
            tbody.appendChild(tr);
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            saveToLocalStorage();
        }

        // ===== دوال التوقيع =====
        function initLargeCanvas() {
            const canvas = document.getElementById('largeCanvas');
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function getPos(e) {
            const canvas = document.getElementById('largeCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return [(clientX - rect.left) * scaleX, (clientY - rect.top) * scaleY];
        }

        function startDrawing(e) { e.preventDefault(); isDrawing = true; [lastX, lastY] = getPos(e); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const [currentX, currentY] = getPos(e); const ctx = document.getElementById('largeCanvas').getContext('2d'); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(currentX, currentY); ctx.stroke(); [lastX, lastY] = [currentX, currentY]; }
        function stopDrawing() { isDrawing = false; }
        
        function openModal(canvasId) { currentCanvasId = canvasId; document.getElementById('signatureModal').style.display = 'block'; clearLargeCanvas(); }
        function closeModal() { document.getElementById('signatureModal').style.display = 'none'; currentCanvasId = null; }
        function clearLargeCanvas() { const canvas = document.getElementById('largeCanvas'); canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
        function saveLargeSignature() { if (!currentCanvasId) return; const largeCanvas = document.getElementById('largeCanvas'); const smallCanvas = document.getElementById(currentCanvasId); const dataURL = largeCanvas.toDataURL(); smallCanvas.style.backgroundImage = `url(${dataURL})`; smallCanvas.style.backgroundSize = 'contain'; smallCanvas.style.backgroundRepeat = 'no-repeat'; smallCanvas.style.backgroundPosition = 'center'; smallCanvas.innerHTML = ''; closeModal(); saveToLocalStorage(); }
        function clearCanvas(canvasId) { const canvas = document.getElementById(canvasId); canvas.style.backgroundImage = ''; canvas.innerHTML = 'انقر هنا للتوقيع'; saveToLocalStorage(); }
        function saveSignature() { saveToLocalStorage(); }

        // ===== دوال مؤشر التحميل والصور =====
        const loader = document.getElementById('loader');
        function showLoader() { loader.classList.add('show'); }
        function hideLoader() { loader.classList.remove('show'); }
        function openCamera() { document.getElementById('cameraInput').click(); }
        function openGallery() { document.getElementById('galleryInput').click(); }
        function resizeImage(file) { return new Promise((resolve, reject) => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const img = new Image(); img.onload = () => { let { width, height } = img; const ratio = Math.min(PHOTO_CONFIG.maxWidth / width, PHOTO_CONFIG.maxHeight / height); if (ratio < 1) { width *= ratio; height *= ratio; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('Canvas to Blob failed.')), PHOTO_CONFIG.format, PHOTO_CONFIG.quality); }; img.onerror = () => reject(new Error('Image load failed.')); img.src = URL.createObjectURL(file); }); }
        async function handlePhotoSelection(event) {
            const files = Array.from(event.target.files); if (files.length === 0) return; showLoader();
            try {
                for (const file of files) { if (file.type.startsWith('image/')) { const resizedBlob = await resizeImage(file); const photoData = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve({ id: Date.now() + Math.random(), src: e.target.result, name: file.name }); reader.onerror = reject; reader.readAsDataURL(resizedBlob); }); attachedPhotos.push(photoData); } }
                displayPhotos(); saveToLocalStorage();
            } catch (error) { console.error("Error processing images:", error); alert("An error occurred while processing an image."); } 
            finally { hideLoader(); event.target.value = ''; }
        }
        
        function displayPhotos() {
            const photosGrid = document.getElementById('photosGrid');
            if (attachedPhotos.length === 0) {
                photosGrid.innerHTML = '<div class="no-photos">لا توجد صور مرفقة بعد</div>';
                return;
            }
            photosGrid.innerHTML = attachedPhotos.map(photo => `
                <div class="photo-item">
                    <img src="${photo.src}" alt="${photo.name}" loading="lazy">
                    <button class="photo-remove" onclick="removePhoto('${photo.id}')" title="حذف الصورة"><i class="fas fa-times"></i></button>
                    <button class="photo-crop" onclick="openCropper('${photo.id}')" title="قص الصورة"><i class="fas fa-crop-alt"></i></button>
                </div>
            `).join('');
        }
        
        function removePhoto(photoId) { attachedPhotos = attachedPhotos.filter(photo => photo.id != photoId); displayPhotos(); saveToLocalStorage(); }
        
        // ===== دوال قص الصور =====
        function openCropper(photoId) {
            const photo = attachedPhotos.find(p => p.id == photoId);
            if (!photo) return;
            currentPhotoIdToCrop = photoId;
            const modal = document.getElementById('cropperModal');
            const image = document.getElementById('imageToCrop');
            image.src = photo.src;
            modal.style.display = 'block';

            image.onload = () => {
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(image, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    background: false,
                    responsive: true,
                    autoCropArea: 0.8,
                });
            };
        }

        function closeCropper() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('cropperModal').style.display = 'none';
            currentPhotoIdToCrop = null;
        }

        function saveCroppedImage() {
            if (!cropper || !currentPhotoIdToCrop) return;
            showLoader();
            const croppedCanvas = cropper.getCroppedCanvas({
                maxWidth: PHOTO_CONFIG.maxWidth,
                maxHeight: PHOTO_CONFIG.maxHeight,
            });

            const newSrc = croppedCanvas.toDataURL(PHOTO_CONFIG.format, PHOTO_CONFIG.quality);
            const photoIndex = attachedPhotos.findIndex(p => p.id == currentPhotoIdToCrop);
            if (photoIndex > -1) {
                attachedPhotos[photoIndex].src = newSrc;
            }
            
            displayPhotos();
            saveToLocalStorage();
            closeCropper();
            hideLoader();
        }

        function getBranchName() { const branchInput = document.getElementById('branchInput'); let branchName = branchInput.value.trim() || branchInput.placeholder || 'فرع'; return branchName.replace(/[^a-zA-Z0-9\u0600-\u06FF\s]/g, '').replace(/\s+/g, '_'); }
        function downloadImage(canvas, fileName) { const link = document.createElement("a"); link.download = `${fileName}.png`; link.href = canvas.toDataURL('image/png', 1.0); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

        // ===== دالة المشاركة =====
        function shareReport() {
            showLoader();
            const branchName = getBranchName();
            const currentDate = new Date().toISOString().split('T')[0];
            const fileName = `تقرير_صيانة_${branchName}_${currentDate}`;
            const replacedTextareas = [];
            document.querySelectorAll("textarea").forEach(textarea => {
                const tempDiv = document.createElement("div"); tempDiv.innerHTML = textarea.value.replace(/\n/g, "<br>"); tempDiv.className = "textarea-replacement"; textarea.parentNode.replaceChild(tempDiv, textarea); replacedTextareas.push({ original: textarea, replacement: tempDiv });
            });
            document.querySelectorAll(".no-print").forEach(el => el.style.visibility = 'hidden');
            
            const options = { useCORS: true, scale: 3, scrollX: -window.scrollX, scrollY: -window.scrollY, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight, backgroundColor: '#ffffff' };

            html2canvas(document.getElementById("reportArea"), options).then(canvas => {
                downloadImage(canvas, fileName);
                canvas.toBlob(function(blob) {
                    const file = new File([blob], `${fileName}.png`, { type: "image/png" });
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: `تقرير صيانة - ${branchName}`, text: `تم إنشاء تقرير صيانة لفرع ${branchName}` })
                        .catch(err => console.log("Sharing failed or was cancelled:", err));
                    }
                }, 'image/png', 1.0);
            }).catch(error => {
                console.error('Error generating image:', error);
                alert('An error occurred while creating the image.');
            }).finally(() => {
                replacedTextareas.forEach(item => { item.replacement.parentNode.replaceChild(item.original, item.replacement); });
                document.querySelectorAll(".no-print").forEach(el => el.style.visibility = 'visible');
                hideLoader();
            });
        }

        // ===== دوال التخزين المحلي =====
        function saveToLocalStorage() {
            const dataToStore = {
                inputs: Array.from(document.querySelectorAll('input[type="text"], input[type="date"]')).reduce((acc, input) => { acc[input.id || input.name] = input.value; return acc; }, {}),
                textareas: Array.from(document.querySelectorAll('textarea[id]')).reduce((acc, ta) => { acc[ta.id] = ta.value; return acc; }, {}),
                checkboxes: Array.from(document.querySelectorAll('input[type="checkbox"]')).reduce((acc, cb) => { acc[cb.id] = cb.checked; return acc; }, {}),
                radios: Array.from(document.querySelectorAll('input[type="radio"]:checked')).reduce((acc, radio) => { acc[radio.name] = radio.id; return acc; }, {}),
                tableRows: Array.from(document.querySelectorAll('#partsTable tbody tr')).map(row => Array.from(row.querySelectorAll('textarea')).map(ta => ta.value)),
                photos: attachedPhotos,
                managerSign: document.getElementById('managerSign').style.backgroundImage,
                techSign: document.getElementById('techSign').style.backgroundImage
            };
            const expiration = Date.now() + (EXPIRATION_MINUTES * 60 * 1000);
            const dataWithExpiry = { expiresAt: expiration, data: dataToStore };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataWithExpiry));
        }

        function loadFromLocalStorage() {
            const storedItem = localStorage.getItem(STORAGE_KEY);
            if (!storedItem) return;
            const { expiresAt, data } = JSON.parse(storedItem);
            if (Date.now() > expiresAt) { localStorage.removeItem(STORAGE_KEY); return; }
            
            for (const id in data.inputs) { const input = document.getElementById(id) || document.querySelector(`input[name="${id}"]`); if (input) input.value = data.inputs[id]; }
            for (const id in data.textareas) { const textarea = document.getElementById(id); if (textarea) { textarea.value = data.textareas[id]; autoExpand(textarea); } }
            for (const id in data.checkboxes) { const checkbox = document.getElementById(id); if (checkbox) checkbox.checked = data.checkboxes[id]; }
            for (const name in data.radios) { const radio = document.getElementById(data.radios[name]); if (radio) radio.checked = true; }
            
            if (data.tableRows && data.tableRows.length > 0) {
                const tbody = document.querySelector('#partsTable tbody');
                tbody.innerHTML = ''; 
                data.tableRows.forEach(rowData => {
                    addRow();
                    const newRowTextareas = tbody.lastChild.querySelectorAll('textarea');
                    rowData.forEach((value, i) => { if(newRowTextareas[i]) { newRowTextareas[i].value = value; autoExpand(newRowTextareas[i]); } });
                });
            }

            if (data.photos) { attachedPhotos = data.photos; displayPhotos(); }
            if (data.managerSign) { const sign = document.getElementById('managerSign'); sign.style.backgroundImage = data.managerSign; sign.style.backgroundSize = 'contain'; sign.style.backgroundRepeat = 'no-repeat'; sign.style.backgroundPosition = 'center'; sign.innerHTML = ''; }
            if (data.techSign) { const sign = document.getElementById('techSign'); sign.style.backgroundImage = data.techSign; sign.style.backgroundSize = 'contain'; sign.style.backgroundRepeat = 'no-repeat'; sign.style.backgroundPosition = 'center'; sign.innerHTML = ''; }
        }

        function clearLocalStorage() {
            if (confirm("هل أنت متأكد أنك تريد مسح جميع البيانات المحفوظة؟")) {
                localStorage.removeItem(STORAGE_KEY);
                resetForm();
                alert("تم مسح البيانات وتفريغ النموذج بنجاح.");
            }
        }
        
        function resetForm() {
            document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
            document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(el => el.checked = false);
            clearCanvas('managerSign');
            clearCanvas('techSign');
            attachedPhotos = [];
            displayPhotos();
            const tbody = document.querySelector('#partsTable tbody');
            tbody.innerHTML = '';
            addRow();
        }

        document.addEventListener('input', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) { saveToLocalStorage(); }
        });
        document.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox' || e.target.type === 'radio') { saveToLocalStorage(); }
        });
    </script>
</body>
</html>
